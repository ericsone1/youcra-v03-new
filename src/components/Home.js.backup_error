import React, { useState, useCallback, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { FaYoutube, FaPlay, FaUsers, FaThumbsUp, FaHeart, FaChevronUp, FaChevronDown } from 'react-icons/fa';
import { BsCheckCircleFill } from 'react-icons/bs';
import { extractChannelId, fetchYouTubeChannelInfo, fetchChannelVideos } from '../services/videoService';

const Home = () => {
  // ë‹¨ê³„ë³„ ì§„í–‰ ìƒíƒœ
  const [completedSteps, setCompletedSteps] = useState([]);
  const [channelConnected, setChannelConnected] = useState(false);
  const [selectedVideos, setSelectedVideos] = useState([]);
  const [activeTab, setActiveTab] = useState('watch'); // watch, myVideos
  const [videoSelectionCollapsed, setVideoSelectionCollapsed] = useState(false);
  
  // ë°ì´í„° ìƒíƒœ
  const [channelInfo, setChannelInfo] = useState(null);
  const [channelUrl, setChannelUrl] = useState('');
  const [channelLoading, setChannelLoading] = useState(false);
  const [channelError, setChannelError] = useState('');
  const [myVideos, setMyVideos] = useState([]);
  const [videosLoading, setVideosLoading] = useState(false);
  const [currentPage, setCurrentPage] = useState(0);
  const [watchedCount, setWatchedCount] = useState(0);
  const [earnedViews, setEarnedViews] = useState(0);

  // ê¸°ë³¸ ì´ë¯¸ì§€ URLë“¤ - useMemoë¡œ ë©”ëª¨ì´ì œì´ì…˜
  const defaultImages = useMemo(() => ({
    channelAvatar: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjE1IiBmaWxsPSIjOUI5QkEzIi8+CjxwYXRoIGQ9Ik0yMCA3NUMyMCA2NS41IDI5LjUgNTggNDEgNThINTlDNzAuNSA1OCA4MCA2NS41IDgwIDc1VjgwSDIwVjc1WiIgZmlsbD0iIzlCOUJBMyIvPgo8L3N2Zz4K',
    videoThumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjE2MCIgY3k9IjkwIiByPSIzMCIgZmlsbD0iI0VGNDQ0NCIvPgo8cGF0aCBkPSJNMTUwIDc1TDE3NSA5MEwxNTAgMTA1Vjc1WiIgZmlsbD0iI0ZGRkZGRiIvPgo8L3N2Zz4K'
  }), []);

  // ì„ì‹œ ë°ì´í„° - useMemoë¡œ ë©”ëª¨ì´ì œì´ì…˜
  const mockWatchQueue = useMemo(() => [
    {
      id: '1',
      title: 'ë§›ìˆëŠ” ìš”ë¦¬ ë ˆì‹œí”¼ ê³µìœ ',
      channelName: 'ìš”ë¦¬ì™•ê¹€ì†Œì—°',
      thumbnailUrl: defaultImages.videoThumbnail,
      duration: '3:24',
      type: 'short',
      views: 1200,
      isWatched: false
    },
    {
      id: '2',
      title: '10ë¶„ë§Œì— ì™„ì„±í•˜ëŠ” í™ˆíŠ¸ë ˆì´ë‹',
      channelName: 'í—¬ìŠ¤íŠ¸ë ˆì´ë„ˆë°•',
      thumbnailUrl: defaultImages.videoThumbnail,
      duration: '10:15',
      type: 'long',
      views: 850,
      isWatched: false
    }
  ], [defaultImages.videoThumbnail]);

  const mockMyVideos = useMemo(() => [
    {
      id: 'my1',
      title: 'ë‚´ê°€ ì˜¬ë¦° ì˜ìƒ 1',
      thumbnailUrl: defaultImages.videoThumbnail,
      duration: '2:30',
      type: 'short',
      watchProgress: 75,
      totalViewers: 12,
      currentViewers: 3
    },
    {
      id: 'my2',
      title: 'ë‚´ê°€ ì˜¬ë¦° ì˜ìƒ 2',
      thumbnailUrl: defaultImages.videoThumbnail,
      duration: '5:15',
      type: 'long',
      watchProgress: 45,
      totalViewers: 8,
      currentViewers: 1
    },
    {
      id: 'my3',
      title: 'ë‚´ê°€ ì˜¬ë¦° ì˜ìƒ 3',
      thumbnailUrl: defaultImages.videoThumbnail,
      duration: '1:45',
      type: 'short',
      watchProgress: 90,
      totalViewers: 15,
      currentViewers: 2
    }
  ], [defaultImages.videoThumbnail]);

  // ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬ - useCallbackìœ¼ë¡œ ë©”ëª¨ì´ì œì´ì…˜
  const completeStep = useCallback((stepNumber) => {
    setCompletedSteps(prev => {
      if (!prev.includes(stepNumber)) {
        return [...prev, stepNumber];
      }
      return prev;
    });
  }, []);

  // ì´ë¯¸ì§€ ì—ëŸ¬ í•¸ë“¤ë§ - useCallbackìœ¼ë¡œ ë©”ëª¨ì´ì œì´ì…˜
  const handleImageError = useCallback((e) => {
    e.target.src = defaultImages.videoThumbnail;
  }, [defaultImages.videoThumbnail]);

  const handleAvatarError = useCallback((e) => {
    e.target.src = defaultImages.channelAvatar;
  }, [defaultImages.channelAvatar]);

  // ì±„ë„ ì—°ë™ í•¸ë“¤ëŸ¬
  const handleChannelConnect = useCallback(async () => {
    if (!channelUrl.trim()) {
      setChannelError('ì±„ë„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    setChannelLoading(true);
    setChannelError('');

    try {
      // 1. URLì—ì„œ ì±„ë„ ì •ë³´ ì¶”ì¶œ
      const channelData = extractChannelId(channelUrl);
      if (!channelData) {
        throw new Error('ìœ íš¨í•œ ìœ íŠœë¸Œ ì±„ë„ URLì´ ì•„ë‹™ë‹ˆë‹¤.');
      }

      // 2. YouTube APIë¡œ ì±„ë„ ì •ë³´ ì¡°íšŒ
      console.log('ğŸ” ì±„ë„ ì •ë³´ ì¡°íšŒ ì‹œì‘:', channelData);
      const channelInfo = await fetchYouTubeChannelInfo(channelData);
      
      if (!channelInfo) {
        throw new Error('ì±„ë„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      // 3. ì±„ë„ ì •ë³´ ì €ì¥
      setChannelInfo({
        name: channelInfo.channelTitle,
        subscribers: formatSubscriberCount(channelInfo.subscriberCount),
        avatar: channelInfo.channelThumbnail || defaultImages.channelAvatar,
        videoCount: channelInfo.videoCount,
        viewCount: channelInfo.viewCount,
        description: channelInfo.channelDescription,
        channelId: channelInfo.channelId
      });

      // 4. ì±„ë„ì˜ ì‹¤ì œ ì˜ìƒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      setVideosLoading(true);
      console.log('ğŸ” ì±„ë„ ì˜ìƒ ëª©ë¡ ì¡°íšŒ ì‹œì‘...');
      
      try {
        const videos = await fetchChannelVideos(channelInfo.channelId, 10); // ìµœì‹  10ê°œ ì˜ìƒ
        
        if (videos && videos.length > 0) {
          setMyVideos(videos);
          resetPagination(); // ìƒˆ ì˜ìƒ ë¡œë“œ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
          console.log(`âœ… ì‹¤ì œ ì˜ìƒ ${videos.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
          console.log('ğŸ“Š ìˆí¼/ë¡±í¼ ë¶„í¬:', {
            shorts: videos.filter(v => v.type === 'short').length,
            longs: videos.filter(v => v.type === 'long').length
          });
        } else {
          console.warn('âš ï¸ ì˜ìƒì´ ì—†ì–´ Mock ë°ì´í„° ì‚¬ìš©');
          setMyVideos(mockMyVideos);
          resetPagination();
        }
              } catch (videoError) {
          console.error('âŒ ì˜ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', videoError);
          setMyVideos(mockMyVideos);
          resetPagination();
        } finally {
        setVideosLoading(false);
      }

      setChannelConnected(true);
      completeStep(1);
      
      console.log('âœ… ì±„ë„ ì—°ë™ ì™„ë£Œ:', channelInfo.channelTitle);
    } catch (error) {
      console.error('âŒ ì±„ë„ ì—°ë™ ì‹¤íŒ¨:', error);
      setChannelError(error.message || 'ì±„ë„ ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setChannelLoading(false);
    }
  }, [channelUrl, defaultImages.channelAvatar, completeStep, mockMyVideos, resetPagination]);

  // êµ¬ë…ì ìˆ˜ í¬ë§·íŒ… í•¨ìˆ˜
  const formatSubscriberCount = useCallback((count) => {
    if (!count) return '0';
    if (count >= 1000000) {
      return (count / 1000000).toFixed(1) + 'M';
    } else if (count >= 1000) {
      return (count / 1000).toFixed(1) + 'K';
    } else {
      return count.toString();
    }
  }, []);

  // ì¡°íšŒìˆ˜ í¬ë§·íŒ… í•¨ìˆ˜
  const formatViewCount = useCallback((count) => {
    if (!count) return '0';
    if (count >= 1000000000) {
      return (count / 1000000000).toFixed(1) + 'B';
    } else if (count >= 1000000) {
      return (count / 1000000).toFixed(1) + 'M';
    } else if (count >= 1000) {
      return (count / 1000).toFixed(1) + 'K';
    } else {
      return count.toLocaleString();
    }
  }, []);

  // ì˜ìƒ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleVideoSelect = useCallback((videoId) => {
    console.log('ì˜ìƒ ì„ íƒë¨:', videoId);
    setSelectedVideos(prev => {
      console.log('í˜„ì¬ ì„ íƒëœ ì˜ìƒë“¤:', prev);
      if (prev.includes(videoId)) {
        const newSelection = prev.filter(id => id !== videoId);
        console.log('ì˜ìƒ ì„ íƒ í•´ì œ, ìƒˆë¡œìš´ ì„ íƒ:', newSelection);
        return newSelection;
      } else if (prev.length < 3) {
        const newSelection = [...prev, videoId];
        console.log('ì˜ìƒ ì„ íƒ ì¶”ê°€, ìƒˆë¡œìš´ ì„ íƒ:', newSelection);
        return newSelection;
      }
      console.log('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥');
      return prev;
    });
  }, []);

  // ì‹œì²­í•˜ê¸° í•¸ë“¤ëŸ¬
  const handleWatchVideo = useCallback(() => {
    setWatchedCount(prev => prev + 1);
    setEarnedViews(prev => prev + 1);
  }, []);

  // íƒ­ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleTabChange = useCallback((tab) => {
    setActiveTab(tab);
  }, []);

  // í˜ì´ì§€ë„¤ì´ì…˜ ìƒìˆ˜ ë° ë¡œì§
  const VIDEOS_PER_PAGE = 7;
  const totalVideos = myVideos.length > 0 ? myVideos : mockMyVideos;
  const totalPages = Math.ceil(totalVideos.length / VIDEOS_PER_PAGE);
  const startIndex = currentPage * VIDEOS_PER_PAGE;
  const endIndex = startIndex + VIDEOS_PER_PAGE;
  const currentVideos = totalVideos.slice(startIndex, endIndex);

  // í˜ì´ì§€ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handlePageChange = useCallback((pageIndex) => {
    setCurrentPage(pageIndex);
  }, []);

  // ì˜ìƒ ì„ íƒ ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”
  const resetPagination = useCallback(() => {
    setCurrentPage(0);
  }, []);

  // ë‹¨ê³„ë³„ ì»´í¬ë„ŒíŠ¸ë“¤ì„ React.memoë¡œ ìµœì í™”
  const ChannelConnectionStep = React.memo(() => (
    <motion.div
      initial={{ opacity: 0, height: 0 }}
      animate={{ opacity: 1, height: 'auto' }}
      transition={{ duration: 0.5, ease: 'easeOut' }}
      className="overflow-hidden"
    >
      <motion.div
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.2, duration: 0.5 }}
        className="bg-white rounded-2xl p-6 mx-4 shadow-lg mb-6"
      >
        <div className="text-center mb-6">
          <FaYoutube className="text-red-500 text-4xl mx-auto mb-2" />
          <h2 className="text-xl font-bold text-gray-800">ìœ íŠœë¸Œ ì±„ë„ ì—°ë™</h2>
          <p className="text-gray-600 text-sm mt-2">
            ë‚´ ì±„ë„ì„ ì—°ë™í•˜ê³  ì‹œì²­ë°›ì„ ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”
          </p>
        </div>

        {!channelConnected ? (
          <div className="space-y-4">
            <input
              type="text"
              value={channelUrl}
              onChange={(e) => setChannelUrl(e.target.value)}
              placeholder="ìœ íŠœë¸Œ ì±„ë„ URL ë˜ëŠ” í•¸ë“¤ ì…ë ¥ (ì˜ˆ: @ì±„ë„ëª…, https://youtube.com/@ì±„ë„ëª…)"
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
              disabled={channelLoading}
            />
            {channelError && (
              <div className="text-red-500 text-sm bg-red-50 p-3 rounded-lg">
                {channelError}
              </div>
            )}
            <button
              onClick={handleChannelConnect}
              disabled={channelLoading || !channelUrl.trim()}
              className="w-full bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              {channelLoading ? 'ì—°ë™ ì¤‘...' : 'ì±„ë„ ì—°ë™í•˜ê¸°'}
            </button>
          </div>
        ) : (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            className="p-4 bg-green-50 rounded-xl border-2 border-green-200"
          >
            <div className="flex items-center gap-4 mb-3">
              <img
                src={channelInfo?.avatar}
                alt="ì±„ë„"
                className="w-16 h-16 rounded-full object-cover"
                onError={handleAvatarError}
              />
              <div className="flex-1">
                <h3 className="font-bold text-lg">{channelInfo?.name}</h3>
                <p className="text-gray-500">êµ¬ë…ì {channelInfo?.subscribers}ëª…</p>
              </div>
              <BsCheckCircleFill className="text-green-500 text-2xl" />
            </div>
            
            {/* ì¶”ê°€ ì •ë³´ */}
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div className="bg-white rounded-lg p-3">
                <div className="text-gray-500">ì—…ë¡œë“œ ì˜ìƒ</div>
                <div className="font-bold text-lg">{channelInfo?.videoCount?.toLocaleString() || 0}ê°œ</div>
              </div>
              <div className="bg-white rounded-lg p-3">
                <div className="text-gray-500">ì´ ì¡°íšŒìˆ˜</div>
                <div className="font-bold text-lg">{formatViewCount(channelInfo?.viewCount)}</div>
              </div>
            </div>
          </motion.div>
        )}
      </motion.div>
    </motion.div>
  ));

  const VideoSelectionStep = React.memo(() => (
    <AnimatePresence initial={false}>
      {completedSteps.includes(1) && (
        <motion.div
          key="video-selection-container"
          initial={false}
          animate={{ opacity: 1, height: 'auto' }}
          transition={{ duration: 0.3, ease: 'easeOut' }}
          className="overflow-hidden"
        >
          <motion.div
            initial={{ y: 20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="bg-white rounded-2xl p-6 mx-4 shadow-lg mb-6"
          >
            {/* í—¤ë” - í•­ìƒ í‘œì‹œ */}
            <div 
              className="flex justify-between items-center mb-4 cursor-pointer"
              onClick={() => setVideoSelectionCollapsed(!videoSelectionCollapsed)}
            >
              <h3 className="text-xl font-bold">ì‹œì²­ë°›ì„ ì˜ìƒ ì„ íƒ</h3>
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-500">
                  {selectedVideos.length}/3 ì„ íƒ
                  {totalPages > 1 && !videosLoading && ` â€¢ ${currentPage + 1}/${totalPages} í˜ì´ì§€`}
                </span>
                {completedSteps.includes(2) && (
                  <motion.div
                    animate={{ rotate: videoSelectionCollapsed ? 0 : 180 }}
                    transition={{ duration: 0.2 }}
                  >
                    <FaChevronDown className="text-gray-400" />
                  </motion.div>
                )}
              </div>
            </div>

            {/* ì™„ë£Œ ìƒíƒœ ìš”ì•½ - ì ‘í˜”ì„ ë•Œ í‘œì‹œ */}
            {completedSteps.includes(2) && videoSelectionCollapsed && (
              <div className="flex justify-between items-center">
                <div className="text-sm text-gray-600">
                  <span>âœ… ì„ íƒ ì™„ë£Œ ({selectedVideos.length}ê°œ)</span>
                </div>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setVideoSelectionCollapsed(false);
                  }}
                  className="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 transition-colors duration-150"
                >
                  ìˆ˜ì •í•˜ê¸°
                </button>
              </div>
            )}

            {/* ì˜ìƒ ë¦¬ìŠ¤íŠ¸ - ì ‘ê¸°/í¼ì¹˜ê¸° */}
            <AnimatePresence initial={false}>
              {!videoSelectionCollapsed && (
                <motion.div
                  initial={{ height: 0, opacity: 0 }}
                  animate={{ height: 'auto', opacity: 1 }}
                  exit={{ height: 0, opacity: 0 }}
                  transition={{ duration: 0.3 }}
                  className="overflow-hidden"
                >
                  {videosLoading ? (
                    <div className="text-center py-8">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-3"></div>
                      <p className="text-gray-500 text-sm">ì˜ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                  ) : (
                    <div className="space-y-3 mb-4">
                      {currentVideos.map((video) => {
                      const isSelected = selectedVideos.includes(video.id);
                      return (
                        <motion.div
                          key={video.id}
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleVideoSelect(video.id);
                          }}
                          className={`relative flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-colors duration-150 select-none ${
                            isSelected 
                              ? 'bg-blue-50 border-2 border-blue-500' 
                              : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                          }`}
                          style={{ userSelect: 'none' }}
                        >
                          <img
                            src={video.thumbnailUrl}
                            alt={video.title}
                            className="w-16 h-12 rounded-lg object-cover pointer-events-none"
                            onError={handleImageError}
                            draggable={false}
                          />
                          <div className="flex-1 pointer-events-none">
                            <h4 className="font-medium text-sm line-clamp-2">{video.title}</h4>
                            <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                              <span>{video.duration}</span>
                              <span>â€¢</span>
                              <span className={`px-2 py-0.5 rounded-full ${
                                video.type === 'short' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'
                              }`}>
                                {video.type === 'short' ? 'ìˆí¼' : 'ë¡±í¼'}
                              </span>
                              {video.viewCount && (
                                <>
                                  <span>â€¢</span>
                                  <span>ì¡°íšŒìˆ˜ {formatViewCount(video.viewCount)}</span>
                                </>
                              )}
                            </div>
                          </div>
                          <div className="pointer-events-none">
                            <BsCheckCircleFill
                              className={`text-2xl transition-colors duration-150 ${
                                isSelected ? 'text-blue-500' : 'text-gray-300'
                              }`}
                            />
                          </div>
                        </motion.div>
                      );
                    })}
                    </div>

                    {/* í˜ì´ì§€ë„¤ì´ì…˜ */}
                    {totalPages > 1 && (
                      <div className="flex justify-center items-center gap-2 py-4">
                        <button
                          onClick={() => handlePageChange(Math.max(0, currentPage - 1))}
                          disabled={currentPage === 0}
                          className="px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed bg-gray-100 text-gray-600 hover:bg-gray-200"
                        >
                          ì´ì „
                        </button>
                        
                        <div className="flex gap-1">
                          {Array.from({ length: totalPages }, (_, index) => (
                            <button
                              key={index}
                              onClick={() => handlePageChange(index)}
                              className={`w-8 h-8 rounded-lg text-sm font-medium transition-colors duration-150 ${
                                currentPage === index
                                  ? 'bg-blue-500 text-white'
                                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                              }`}
                            >
                              {index + 1}
                            </button>
                          ))}
                        </div>
                        
                        <button
                          onClick={() => handlePageChange(Math.min(totalPages - 1, currentPage + 1))}
                          disabled={currentPage === totalPages - 1}
                          className="px-3 py-1 rounded-lg text-sm font-medium transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed bg-gray-100 text-gray-600 hover:bg-gray-200"
                        >
                          ë‹¤ìŒ
                        </button>
                      </div>
                    )}
                  )}

                  {selectedVideos.length > 0 && !videosLoading && (
                    <button
                      onClick={() => {
                        completeStep(2);
                        setVideoSelectionCollapsed(true);
                      }}
                      className="w-full bg-blue-500 text-white py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors duration-150"
                    >
                      {completedSteps.includes(2) ? 'ì˜ìƒ ìˆ˜ì • ì™„ë£Œ' : 'ì˜ìƒ ë“±ë¡í•˜ê¸°'} ({selectedVideos.length}ê°œ)
                    </button>
                  )}
                </motion.div>
              )}
            </AnimatePresence>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  ));

  const MainPlatformStep = React.memo(() => (
    <AnimatePresence>
      {completedSteps.includes(2) && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: 'auto' }}
          transition={{ duration: 0.5, ease: 'easeOut' }}
          className="overflow-hidden"
        >
          <motion.div
            initial={{ y: 20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="space-y-4"
          >
            {/* ìƒíƒœ ì¹´ë“œ */}
            <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-6 mx-4 text-white shadow-lg">
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center">
                  <div className="text-2xl font-bold">{watchedCount}</div>
                  <div className="text-sm opacity-90">ë‚´ê°€ ì‹œì²­í•œ ì˜ìƒ</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold">{earnedViews}</div>
                  <div className="text-sm opacity-90">ë°›ì€ ì‹œì²­ìˆ˜</div>
                </div>
              </div>
            </div>

            {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
            <div className="flex bg-gray-100 rounded-2xl p-1 mx-4">
              <button
                onClick={() => handleTabChange('watch')}
                className={`flex-1 py-3 rounded-xl font-medium transition-colors duration-150 ${
                  activeTab === 'watch'
                    ? 'bg-white text-blue-600'
                    : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <FaPlay className="inline mr-2" />
                ì‹œì²­í•  ì˜ìƒ ({mockWatchQueue.length})
              </button>
              <button
                onClick={() => handleTabChange('myVideos')}
                className={`flex-1 py-3 rounded-xl font-medium transition-colors duration-150 ${
                  activeTab === 'myVideos'
                    ? 'bg-white text-blue-600'
                    : 'text-gray-600 hover:text-gray-800'
                }`}
              >
                <FaUsers className="inline mr-2" />
                ë‚´ ì˜ìƒ í˜„í™©
              </button>
            </div>

            {/* íƒ­ ì»¨í…ì¸  */}
            <AnimatePresence mode="wait">
              {activeTab === 'watch' ? (
                <WatchQueueTab key="watch" />
              ) : (
                <MyVideosTab key="myVideos" />
              )}
            </AnimatePresence>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  ));

  const WatchQueueTab = React.memo(() => (
    <motion.div
      initial={{ opacity: 0, x: -20 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: 20 }}
      transition={{ duration: 0.3 }}
      className="space-y-3 mx-4"
    >
      <div className="flex gap-2 mb-4">
        <button className="px-4 py-2 bg-blue-100 text-blue-600 rounded-full text-sm font-medium">
          ì „ì²´
        </button>
        <button className="px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm hover:bg-gray-200 transition-colors">
          ìˆí¼
        </button>
        <button className="px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm hover:bg-gray-200 transition-colors">
          ë¡±í¼
        </button>
      </div>

      {mockWatchQueue.map((video, index) => (
        <motion.div 
          key={video.id} 
          className="bg-white rounded-2xl p-4 shadow-sm"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 * index }}
        >
          <div className="flex gap-3">
            <img
              src={video.thumbnailUrl}
              alt={video.title}
              className="w-20 h-14 rounded-lg object-cover"
              onError={handleImageError}
            />
            <div className="flex-1">
              <h4 className="font-medium text-sm mb-1">{video.title}</h4>
              <p className="text-xs text-gray-500 mb-2">{video.channelName}</p>
              <div className="flex items-center gap-2 text-xs text-gray-500">
                <span>{video.duration}</span>
                <span>â€¢</span>
                <span>ì¡°íšŒìˆ˜ {video.views.toLocaleString()}</span>
                <span className={`px-2 py-1 rounded-full text-xs ${
                  video.type === 'short' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'
                }`}>
                  {video.type === 'short' ? 'ìˆí¼' : 'ë¡±í¼'}
                </span>
              </div>
            </div>
          </div>
          
          <div className="flex gap-2 mt-3">
            <button
              onClick={handleWatchVideo}
              className="flex-1 bg-red-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition-colors"
            >
              <FaPlay className="inline mr-1" />
              ì‹œì²­í•˜ê¸°
            </button>
            <button className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              <FaThumbsUp className="text-gray-600" />
            </button>
            <button className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              <FaHeart className="text-gray-600" />
            </button>
          </div>
        </motion.div>
      ))}

      {mockWatchQueue.length === 0 && (
        <div className="text-center py-8 text-gray-500">
          <FaPlay className="text-4xl mx-auto mb-2 opacity-30" />
          <p>ì‹œì²­í•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="text-sm">ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì˜ìƒì„ ë“±ë¡í•˜ë©´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
        </div>
      )}
    </motion.div>
  ));

  const MyVideosTab = React.memo(() => (
    <motion.div
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: -20 }}
      transition={{ duration: 0.3 }}
      className="space-y-3 mx-4"
    >
      {selectedVideos.map((videoId, index) => {
        const video = (myVideos.length > 0 ? myVideos : mockMyVideos).find(v => v.id === videoId);
        if (!video) return null;
        
        return (
          <motion.div 
            key={video.id} 
            className="bg-white rounded-2xl p-4 shadow-sm"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 * index }}
          >
            <div className="flex gap-3 mb-3">
              <img
                src={video.thumbnailUrl}
                alt={video.title}
                className="w-20 h-14 rounded-lg object-cover"
                onError={handleImageError}
              />
              <div className="flex-1">
                <h4 className="font-medium text-sm mb-1">{video.title}</h4>
                <div className="text-xs text-gray-500">
                  <span>{video.duration}</span>
                  <span className="ml-2">í˜„ì¬ ì‹œì²­ì {video.currentViewers}ëª…</span>
                </div>
              </div>
            </div>

            {/* ì‹œì²­ë¥  ê²Œì´ì§€ */}
            <div className="mb-3">
              <div className="flex justify-between text-sm mb-1">
                <span className="text-gray-600">ì‹œì²­ ì§„í–‰ë¥ </span>
                <span className="font-medium">{video.watchProgress}%</span>
              </div>
              <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <motion.div
                  initial={{ width: 0 }}
                  animate={{ width: `${video.watchProgress}%` }}
                  transition={{ duration: 1, delay: 0.2 * index }}
                  className="h-full bg-green-500 rounded-full"
                />
              </div>
            </div>

            <div className="flex justify-between text-sm text-gray-600">
              <span>ì´ ì‹œì²­ì {video.totalViewers}ëª…</span>
              <span>ëˆ„ì  ì‹œì²­ ì™„ë£Œ</span>
            </div>
          </motion.div>
        );
      })}

      {selectedVideos.length === 0 && (
        <div className="text-center py-8 text-gray-500">
          <FaUsers className="text-4xl mx-auto mb-2 opacity-30" />
          <p>ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      )}
    </motion.div>
  ));

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      {/* í—¤ë” */}
      <header className="bg-white shadow-sm sticky top-0 z-10">
        <div className="px-4 py-4">
          <h1 className="text-xl font-bold text-center mb-4">ìœ í¬ë¼ ìƒí˜¸ì‹œì²­</h1>
          
          {/* ì§„í–‰ ìƒí™© í‘œì‹œ */}
          <div className="flex items-center justify-center space-x-4">
            <div className={`flex items-center space-x-2 ${completedSteps.includes(1) ? 'text-green-600' : 'text-blue-600'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                completedSteps.includes(1) ? 'bg-green-100' : 'bg-blue-100'
              }`}>
                1
              </div>
              <span className="text-sm">ì±„ë„ ì—°ë™</span>
            </div>
            <div className={`w-8 h-0.5 ${completedSteps.includes(1) ? 'bg-green-300' : 'bg-gray-300'}`}></div>
            <div className={`flex items-center space-x-2 ${completedSteps.includes(2) ? 'text-green-600' : completedSteps.includes(1) ? 'text-blue-600' : 'text-gray-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                completedSteps.includes(2) ? 'bg-green-100' : completedSteps.includes(1) ? 'bg-blue-100' : 'bg-gray-100'
              }`}>
                2
              </div>
              <span className="text-sm">ì˜ìƒ ì„ íƒ</span>
            </div>
            <div className={`w-8 h-0.5 ${completedSteps.includes(2) ? 'bg-green-300' : 'bg-gray-300'}`}></div>
            <div className={`flex items-center space-x-2 ${completedSteps.includes(2) ? 'text-blue-600' : 'text-gray-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                completedSteps.includes(2) ? 'bg-blue-100' : 'bg-gray-100'
              }`}>
                3
              </div>
              <span className="text-sm">ë©”ì¸ í”Œë«í¼</span>
            </div>
          </div>
        </div>
      </header>

      {/* ë©”ì¸ ì»¨í…ì¸  */}
      <main className="py-6">
        {/* ë‹¨ê³„ë³„ ì§„í–‰ - ìˆœì°¨ì  í™•ì¥ ë°©ì‹ */}
        <ChannelConnectionStep />
        <VideoSelectionStep />
        <MainPlatformStep />
      </main>
    </div>
  );
};

export default Home;